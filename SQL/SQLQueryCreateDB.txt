-- Создание базы данных
CREATE DATABASE MobilePhoneStore;
GO

USE MobilePhoneStore;
GO

-- 1. Таблица "Салон" (Salon)
CREATE TABLE Salon (
    ID_Salon INT IDENTITY(1,1) PRIMARY KEY,
    Address NVARCHAR(255) NOT NULL,
    Phone NVARCHAR(20) NOT NULL,
    Manager NVARCHAR(100) NOT NULL,
    Region NVARCHAR(100) NOT NULL
);
GO

-- 2. Таблица "Сотрудник" (Employee)
CREATE TABLE Employee (
    ID_Employee INT IDENTITY(1,1) PRIMARY KEY,
    FullName NVARCHAR(100) NOT NULL,
    Position NVARCHAR(100) NOT NULL,
    Phone NVARCHAR(20) NOT NULL,
    Email NVARCHAR(255) NOT NULL,
    Salary DECIMAL(10,2) NOT NULL CHECK (Salary > 0),
    HireDate DATE NOT NULL,
    ID_Salon INT NOT NULL
);
GO

-- 3. Таблица "Клиент" (Client)
CREATE TABLE Client (
    ID_Client INT IDENTITY(1,1) PRIMARY KEY,
    FullName NVARCHAR(100) NOT NULL,
    Phone NVARCHAR(20) NOT NULL,
    Email NVARCHAR(255) NOT NULL,
    Address NVARCHAR(255) NOT NULL,
    RegistrationDate DATE NOT NULL DEFAULT GETDATE()
);
GO

-- 4. Таблица "Продукт" (Product)
CREATE TABLE Product (
    ID_Product INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(255) NOT NULL,
    Type NVARCHAR(50) NOT NULL, -- Например: 'Телефон', 'Аксессуар'
    Manufacturer NVARCHAR(100) NOT NULL,
    Model NVARCHAR(100),
    Price DECIMAL(10,2) NOT NULL CHECK (Price >= 0),
    Warranty NVARCHAR(50) -- Описание гарантии
);
GO

-- 5. Таблица "Тарифный план" (TariffPlan)
CREATE TABLE TariffPlan (
    ID_Tariff INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    Description NVARCHAR(MAX) NOT NULL,
    Cost DECIMAL(10,2) NOT NULL CHECK (Cost >= 0),
    Features NVARCHAR(MAX) -- Особенности тарифа
);
GO

-- 6. Таблица "Продажа" (Sale)
CREATE TABLE Sale (
    ID_Sale INT IDENTITY(1,1) PRIMARY KEY,
    ID_Client INT,
    ID_Employee INT NOT NULL,
    ID_Product INT NOT NULL,
    SaleDate DATETIME2 NOT NULL DEFAULT GETDATE(),
    TotalAmount DECIMAL(10,2) NOT NULL CHECK (TotalAmount >= 0),
    Comment NVARCHAR(MAX)
);
GO

-- 7. Таблица "Контракт" (Contract)
CREATE TABLE Contract (
    ID_Contract INT IDENTITY(1,1) PRIMARY KEY,
    ID_Client INT NOT NULL,
    ID_Tariff INT NOT NULL,
    ID_Employee INT NOT NULL,
    SigningDate DATE NOT NULL DEFAULT GETDATE(),
    Status NVARCHAR(50) NOT NULL -- Напр., 'Активен', 'Завершен'
);
GO

-- 8. Таблица "Авторизация" (Auth)
CREATE TABLE Auth (
    ID_Auth INT IDENTITY(1,1) PRIMARY KEY,
    ID_Employee INT NOT NULL UNIQUE, -- Каждый сотрудник имеет одну запись авторизации
    Login NVARCHAR(50) NOT NULL UNIQUE,
    Password NVARCHAR(255) NOT NULL,
    AccessLevel NVARCHAR(50) NOT NULL -- Уровень доступа (напр., 'Администратор', 'Менеджер')
);
GO

-- Добавление индексов для внешних ключей (оптимизация запросов)
CREATE INDEX IX_Employee_ID_Salon ON Employee(ID_Salon);
CREATE INDEX IX_Sale_ID_Client ON Sale(ID_Client);
CREATE INDEX IX_Sale_ID_Employee ON Sale(ID_Employee);
CREATE INDEX IX_Sale_ID_Product ON Sale(ID_Product);
CREATE INDEX IX_Contract_ID_Client ON Contract(ID_Client);
CREATE INDEX IX_Contract_ID_Tariff ON Contract(ID_Tariff);
CREATE INDEX IX_Contract_ID_Employee ON Contract(ID_Employee);
CREATE INDEX IX_Auth_ID_Employee ON Auth(ID_Employee);

-- Добавление внешних ключей с каскадным удалением и обновлением

-- Связь Сотрудник -> Салон
ALTER TABLE Employee
ADD CONSTRAINT FK_Employee_Salon
FOREIGN KEY (ID_Salon) REFERENCES Salon(ID_Salon)
ON DELETE CASCADE
ON UPDATE CASCADE;
GO

-- Связь Продажа -> Клиент
ALTER TABLE Sale
ADD CONSTRAINT FK_Sale_Client
FOREIGN KEY (ID_Client) REFERENCES Client(ID_Client)
ON DELETE CASCADE
ON UPDATE CASCADE;
GO

-- Связь Продажа -> Сотрудник
ALTER TABLE Sale
ADD CONSTRAINT FK_Sale_Employee
FOREIGN KEY (ID_Employee) REFERENCES Employee(ID_Employee)
ON DELETE CASCADE
ON UPDATE CASCADE;
GO

-- Связь Продажа -> Продукт
ALTER TABLE Sale
ADD CONSTRAINT FK_Sale_Product
FOREIGN KEY (ID_Product) REFERENCES Product(ID_Product)
ON DELETE CASCADE
ON UPDATE CASCADE;
GO

-- Связь Контракт -> Клиент
ALTER TABLE Contract
ADD CONSTRAINT FK_Contract_Client
FOREIGN KEY (ID_Client) REFERENCES Client(ID_Client)
ON DELETE CASCADE
ON UPDATE CASCADE;
GO

-- Связь Контракт -> Тарифный план
ALTER TABLE Contract
ADD CONSTRAINT FK_Contract_TariffPlan
FOREIGN KEY (ID_Tariff) REFERENCES TariffPlan(ID_Tariff)
ON DELETE CASCADE
ON UPDATE CASCADE;
GO

-- Связь Контракт -> Сотрудник
ALTER TABLE Contract
ADD CONSTRAINT FK_Contract_Employee
FOREIGN KEY (ID_Employee) REFERENCES Employee(ID_Employee)
ON DELETE CASCADE
ON UPDATE CASCADE;
GO

-- Связь Авторизация -> Сотрудник
ALTER TABLE Auth
ADD CONSTRAINT FK_Auth_Employee
FOREIGN KEY (ID_Employee) REFERENCES Employee(ID_Employee)
ON DELETE CASCADE
ON UPDATE CASCADE;
GO

-- Дополнительные проверки (CHECK) для логической целостности
-- Проверка, что дата заключения контракта не может быть в будущем
ALTER TABLE Contract
ADD CONSTRAINT CK_Contract_SigningDate
CHECK (SigningDate <= CAST(GETDATE() AS DATE));
GO

-- Проверка, что дата регистрации клиента не может быть в будущем
ALTER TABLE Client
ADD CONSTRAINT CK_Client_RegistrationDate
CHECK (RegistrationDate <= CAST(GETDATE() AS DATE));
GO

-- Проверка, что дата приема на работу сотрудника не может быть в будущем
ALTER TABLE Employee
ADD CONSTRAINT CK_Employee_HireDate
CHECK (HireDate <= CAST(GETDATE() AS DATE));
GO

-- Проверка, что стоимость тарифного плана не может быть отрицательной
ALTER TABLE TariffPlan
ADD CONSTRAINT CK_TariffPlan_Cost
CHECK (Cost >= 0);
GO

-- Проверка, что цена продукта не может быть отрицательной
ALTER TABLE Product
ADD CONSTRAINT CK_Product_Price
CHECK (Price >= 0);
GO

-- Проверка, что зарплата сотрудника не может быть отрицательной
ALTER TABLE Employee
ADD CONSTRAINT CK_Employee_Salary
CHECK (Salary >= 0);
GO


-- Вывод сообщения об успешном создании БД
PRINT 'База данных MobilePhoneStore успешно создана!';